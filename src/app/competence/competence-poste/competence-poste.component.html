<div class="card">
    <p-toast></p-toast>
    <p-confirmDialog 
        [style]="{width: '450px'}" 
        header="Confirmation" 
        icon="pi pi-exclamation-triangle">
    </p-confirmDialog>
    
    <div class="card-content">
        <h1>Gestion des Compétences Poste</h1>
        <!-- Bouton pour ajouter une nouvelle compétence poste -->
         <div class="toolbar">
            <form class="form">
                <button>
                    <svg width="17" height="16" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="search">
                        <path d="M7.667 12.667A5.333 5.333 0 107.667 2a5.333 5.333 0 000 10.667zM14.334 14l-2.9-2.9" stroke="currentColor" stroke-width="1.333" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </button>
                <input class="input" 
                       placeholder="Rechercher une compétence..." 
                       required 
                       type="text"
                       [(ngModel)]="globalFilter"
                       (input)="applyFilter($event)"
                       name="search">
                <button *ngIf="globalFilter" class="reset" type="reset" (click)="globalFilter = ''; dt?.filterGlobal('', 'contains')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </form>
            <div class="action-buttons">
            <p-button label="Ajouter une Compétence Poste" icon="pi pi-plus" severity="secondary" (click)="showAddDialog()"></p-button>
            <p-button label="Exporter" icon="pi pi-file-excel" severity="contrast" (click)="exportCompetences()">
                <span *ngIf="selectedCompetences.length > 0" class="selection-count">
                    ({{selectedCompetences.length}})
                </span>
            </p-button>
        </div>
    </div>
        <!-- Divider -->
        <div class="divider"></div>

        <!-- Liste des compétences poste avec p-table -->
        <div class="list-container">
            <h3>Liste des Compétences Poste</h3>

            <p-table [value]="competences" [tableStyle]="{ 'min-width': '50rem' }" [paginator]="true" [rows]="5" selectionMode="multiple"
            [(selection)]="selectedCompetences">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Référence</th>
                        <th>Nom</th>
                        <th>Description</th>
                        <th>Options</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-comp>
                    <tr [pSelectableRow]="comp">
                        <td>
                            <span class="id-badge">COMP-{{ comp.id }}</span>
                        </td>
                        <td>{{ comp.nom }}</td>
                        <td>{{ comp.description }}</td>
                        <td>
                            <p-button icon="pi pi-pencil" severity="warn" [rounded]="true" [text]="true"
                                (click)="showEditDialog(comp)" class="action-button">
                            </p-button>
                            <p-button icon="pi pi-times" severity="danger" [rounded]="true" [text]="true"
                                (click)="confirmDelete(comp.id)" class="action-button">
                            </p-button>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="3" class="text-center">Aucune compétence poste enregistrée</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- Boîte de dialogue pour ajouter une compétence poste -->
        <p-dialog header="Ajouter une Compétence Poste" 
                [(visible)]="addDialogVisible" 
                [modal]="true" 
                [style]="{ width: '25rem' }" 
                [draggable]="false" 
                [resizable]="false"
                [closable]="true" 
                [dismissableMask]="true">
            <form [formGroup]="competenceForm" (ngSubmit)="addCompetence()">
                <div class="form-group" [ngClass]="{'has-error': competenceForm.controls['nom'].invalid && competenceForm.controls['nom'].touched}">
                    <label for="nom">Nom de la compétence poste :</label>
                    <input pInputText id="nom" type="text" formControlName="nom" />
                    <small class="text-danger" *ngIf="competenceForm.controls['nom'].hasError('required') && competenceForm.controls['nom'].touched">
                        Ce champ est obligatoire.
                    </small>
                </div>
                <div class="form-group">
                    <label for="description">Description :</label>
                    <textarea pTextarea id="description" formControlName="description" rows="3" cols="30"></textarea>
                </div>

                <div class="form-actions">
                    <button pButton type="button" (click)="addDialogVisible = false" class="p-button-text" severity="danger">Annuler</button>
                    <button pButton type="submit" [disabled]="competenceForm.invalid" severity="contrast" class="p-button-text">Ajouter</button>
                </div>
            </form>
        </p-dialog>

        <!-- Boîte de dialogue pour modifier une compétence poste -->
        <p-dialog header="Modifier la Compétence Poste" 
                [(visible)]="editDialogVisible" 
                [modal]="true" 
                [style]="{ width: '25rem' }" 
                [position]="'center'">
            <form [formGroup]="editCompetenceForm" (ngSubmit)="updateCompetence()">
                <div class="form-group" [ngClass]="{'has-error': editCompetenceForm.controls['nom'].invalid && editCompetenceForm.controls['nom'].touched}">
                    <label for="editNom">Nom de la compétence poste :</label>
                    <input pInputText id="editNom" type="text" formControlName="nom" />
                    <small class="text-danger" *ngIf="editCompetenceForm.controls['nom'].hasError('required') && editCompetenceForm.controls['nom'].touched">
                        Ce champ est obligatoire.
                    </small>
                </div>

                <div class="form-group">
                    <label for="editDescription">Description :</label>
                    <textarea pTextarea id="editDescription" formControlName="description" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button pButton type="button" (click)="editDialogVisible = false" class="p-button-text" severity="danger">Annuler</button>
                    <button pButton type="submit" [disabled]="editCompetenceForm.invalid" severity="success" class="p-button-text">Enregistrer</button>
                </div>
            </form>
        </p-dialog>
    </div>
</div>